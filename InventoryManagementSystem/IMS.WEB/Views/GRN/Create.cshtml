@model IMS.DAL.Models.GRN

@{
    ViewData["Title"] = Model.GRNID == 0 ? "Create GRN" : "Edit GRN";
}

<div class="container-fluid">
    <h2>
        <i class="bi bi-truck"></i> 
        @(Model.GRNID == 0 ? "Create Goods Received Note" : "Edit Goods Received Note")
    </h2>

    @if (TempData["Error"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="bi bi-exclamation-triangle"></i> @TempData["Error"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    <form asp-action="Save" method="post" id="grnForm">
        <input asp-for="GRNID" type="hidden" />

        <div class="card mb-4 shadow-sm">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="bi bi-info-circle"></i> GRN Information</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label asp-for="GRNNo" class="form-label">GRN No</label>
                            <input asp-for="GRNNo" class="form-control" readonly tabindex="-1" />
                        </div>

                        <div class="mb-3">
                            <label asp-for="VendorName" class="form-label">Vendor Name <span class="text-danger">*</span></label>
                            <input asp-for="VendorName" class="form-control" required tabindex="1" />
                            <span asp-validation-for="VendorName" class="text-danger"></span>
                        </div>

                        <div class="mb-3">
                            <label asp-for="Address" class="form-label">Address</label>
                            <textarea asp-for="Address" class="form-control" rows="2" tabindex="2"></textarea>
                        </div>

                        <div class="mb-3">
                            <label asp-for="Tel" class="form-label">Phone</label>
                            <input asp-for="Tel" class="form-control" tabindex="3" />
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="mb-3">
                            <label asp-for="GRNDate" class="form-label">Date <span class="text-danger">*</span></label>
                            <input asp-for="GRNDate" class="form-control" type="date" required tabindex="4" />
                            <span asp-validation-for="GRNDate" class="text-danger"></span>
                        </div>

                        <div class="mb-3">
                            <label asp-for="Amount" class="form-label">Total Amount</label>
                            <input asp-for="Amount" class="form-control" type="number" step="0.01" 
                                   id="totalAmount" readonly tabindex="-1" style="font-size: 1.2rem; font-weight: bold;" />
                            <span asp-validation-for="Amount" class="text-danger"></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card mb-4 shadow-sm">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0"><i class="bi bi-box-seam"></i> Product Lines</h5>
            </div>
            <div class="card-body">
                <div class="row mb-3 g-2">
                    <div class="col-md-3">
                        <input type="text" id="productName" class="form-control" 
                               placeholder="Product Name" tabindex="5" />
                    </div>
                    <div class="col-md-2">
                        <input type="number" id="quantity" class="form-control" 
                               placeholder="Quantity" min="1" tabindex="6" />
                    </div>
                    <div class="col-md-2">
                        <input type="number" id="unitPrice" class="form-control" 
                               placeholder="Unit Price" step="0.01" min="0.01" tabindex="7" />
                    </div>
                    <div class="col-md-2">
                        <input type="number" id="sellingPrice" class="form-control" 
                               placeholder="Selling Price" step="0.01" min="0.01" tabindex="8" />
                    </div>
                    <div class="col-md-3">
                        <button type="button" class="btn btn-success w-100" 
                                onclick="addProductLine()" tabindex="9">
                            <i class="bi bi-plus-circle"></i> Add Product
                        </button>
                    </div>
                </div>

                <div class="table-responsive">
                    <table class="table table-bordered table-hover" id="productTable">
                        <thead class="table-light">
                            <tr>
                                <th width="50">#</th>
                                <th>Description</th>
                                <th width="80">Qty</th>
                                <th width="120">Unit Price</th>
                                <th width="120">Selling Price</th>
                                <th width="120">Total</th>
                                <th width="100">Action</th>
                            </tr>
                        </thead>
                        <tbody id="productLines">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="hiddenLines"></div>

        <div class="mb-3">
            <button type="submit" class="btn btn-primary btn-lg" tabindex="10">
                <i class="bi bi-save"></i> @(Model.GRNID == 0 ? "Save GRN" : "Update GRN")
            </button>
            <a asp-action="Index" class="btn btn-secondary btn-lg">
                <i class="bi bi-x-circle"></i> Cancel
            </a>
        </div>
    </form>
</div>
@section Scripts {
    <script>
        let lineNumber = 1;
        let totalAmount = 0;
        let productLinesArray = [];
        document.addEventListener('DOMContentLoaded', function () {
            const inputs = document.querySelectorAll('input:not([readonly]):not([type="hidden"]), select, textarea');

            inputs.forEach((input, index) => {
                input.addEventListener('keydown', function (e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();

                        if (input.id === 'sellingPrice') {
                            addProductLine();
                            document.getElementById('productName').focus();
                            return;
                        }

                        const nextInput = inputs[index + 1];
                        if (nextInput) {
                            nextInput.focus();
                        }
                    }
                });
            });
        });

        function addProductLine() {
            const productName = document.getElementById('productName').value.trim();
            const quantity = parseInt(document.getElementById('quantity').value);
            const unitPrice = parseFloat(document.getElementById('unitPrice').value);
            const sellingPrice = parseFloat(document.getElementById('sellingPrice').value);

            if (!productName || !quantity || !unitPrice || !sellingPrice) {
                alert('Product Name, Quantity, Unit Price, and Selling Price must be entered.');
                return;
            }

            const total = quantity * unitPrice;

            productLinesArray.push({
                grnLineId: 0,
                productName: productName,
                quantity: quantity,
                unitPrice: unitPrice,
                sellingPrice: sellingPrice,
                total: total
            });

            totalAmount += total;
            document.getElementById('totalAmount').value = totalAmount.toFixed(2);

            document.getElementById('productName').value = '';
            document.getElementById('quantity').value = '';
            document.getElementById('unitPrice').value = '';
            document.getElementById('sellingPrice').value = '';

            rerenderTable();
            updateHiddenFields();

            document.getElementById('productName').focus();
        }

        function deleteLine(index) {
            const lineTotal = productLinesArray[index].total;
            productLinesArray.splice(index, 1);

            totalAmount -= lineTotal;
            document.getElementById('totalAmount').value = totalAmount.toFixed(2);

            rerenderTable();
            updateHiddenFields();
        }

        function rerenderTable() {
            const tbody = document.getElementById('productLines');
            tbody.innerHTML = '';
            lineNumber = 1;

            productLinesArray.forEach((line, index) => {
                const row = `
                        <tr>
                            <td class="text-center">${lineNumber}</td>
                            <td>${line.productName}</td>
                            <td class="text-center">${line.quantity}</td>
                            <td class="text-end">${line.unitPrice.toFixed(2)}</td>
                            <td class="text-end">${line.sellingPrice.toFixed(2)}</td>
                            <td class="text-end">${line.total.toFixed(2)}</td>
                            <td class="text-center">
                                <button type="button" class="btn btn-danger btn-sm" onclick="deleteLine(${index})">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                tbody.insertAdjacentHTML('beforeend', row);
                lineNumber++;
            });
        }

        function updateHiddenFields() {
            const hiddenContainer = document.getElementById('hiddenLines');
            hiddenContainer.innerHTML = '';

            productLinesArray.forEach((line, index) => {
                hiddenContainer.innerHTML += `
                        <input type="hidden" name="GRNLines[${index}].GRNLineID" value="${line.grnLineId}" />
                        <input type="hidden" name="GRNLines[${index}].ProductName" value="${line.productName}" />
                        <input type="hidden" name="GRNLines[${index}].Quantity" value="${line.quantity}" />
                        <input type="hidden" name="GRNLines[${index}].UnitPrice" value="${line.unitPrice}" />
                        <input type="hidden" name="GRNLines[${index}].SellingPrice" value="${line.sellingPrice}" />
                        <input type="hidden" name="GRNLines[${index}].Total" value="${line.total}" />
                    `;
            });
        }

        document.getElementById('grnForm').addEventListener('submit', function (e) {
            const amount = parseFloat(document.getElementById('totalAmount').value);
            if (amount <= 0 || productLinesArray.length === 0) {
                e.preventDefault();
                alert('Amount cannot be zero. Please add at least one product.');
            }
        });
    </script>

    @if (Model.GRNLines != null && Model.GRNLines.Any())
    {
        <script>
            document.addEventListener("DOMContentLoaded", function () {
            @foreach (var line in Model.GRNLines)
            {
                <text>
                            productLinesArray.push({
                                grnLineId: @line.GRNLineID,
                            productName: "@line.ProductName",
                            quantity: @line.Quantity,
                            unitPrice: @line.UnitPrice,
                            sellingPrice: @line.SellingPrice,
                            total: @line.Total
                                    });
                            totalAmount += @line.Total;
                </text>
            }

                    document.getElementById('totalAmount').value = totalAmount.toFixed(2);
                rerenderTable();
                updateHiddenFields();
            });
        </script>
    }
}
