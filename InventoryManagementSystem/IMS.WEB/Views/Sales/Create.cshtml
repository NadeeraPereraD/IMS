@model IMS.DAL.Models.Sales

@{
    ViewData["Title"] = Model.SalesID == 0 ? "Create Sales Invoice" : "Edit Sales Invoice";
    var inventory = ViewBag.Inventory as List<IMS.DAL.Models.Inventory> ?? new List<IMS.DAL.Models.Inventory>();
}

<div class="container-fluid">
    <h2>
        <i class="bi bi-receipt"></i>
        @(Model.SalesID == 0 ? "Create Sales Invoice" : "Edit Sales Invoice")
    </h2>

    @if (TempData["Error"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="bi bi-exclamation-triangle"></i> @TempData["Error"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    <form asp-action="Save" method="post" id="invoiceForm">
        <input asp-for="SalesID" type="hidden" />

        <div class="card mb-4 shadow-sm">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="bi bi-info-circle"></i> Invoice Information</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label asp-for="InvNo" class="form-label">Invoice No</label>
                            <input asp-for="InvNo" class="form-control" readonly tabindex="-1" />
                        </div>

                        <div class="mb-3">
                            <label asp-for="CustomerName" class="form-label">Customer Name <span class="text-danger">*</span></label>
                            <input asp-for="CustomerName" class="form-control" required tabindex="1" />
                            <span asp-validation-for="CustomerName" class="text-danger"></span>
                        </div>

                        <div class="mb-3">
                            <label asp-for="Address" class="form-label">Address</label>
                            <textarea asp-for="Address" class="form-control" rows="2" tabindex="2"></textarea>
                        </div>

                        <div class="mb-3">
                            <label asp-for="Tel" class="form-label">Phone</label>
                            <input asp-for="Tel" class="form-control" tabindex="3" />
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="mb-3">
                            <label asp-for="SalesDate" class="form-label">Date <span class="text-danger">*</span></label>
                            <input asp-for="SalesDate" class="form-control" type="date" required tabindex="4" />
                            <span asp-validation-for="SalesDate" class="text-danger"></span>
                        </div>

                        <div class="mb-3">
                            <label asp-for="SalesType" class="form-label">Sales Type <span class="text-danger">*</span></label>
                            <select asp-for="SalesType" class="form-select" required tabindex="5">
                                <option value="">Select Type</option>
                                <option value="Cash">Cash</option>
                                <option value="Credit">Credit</option>
                            </select>
                            <span asp-validation-for="SalesType" class="text-danger"></span>
                        </div>

                        <div class="mb-3">
                            <label asp-for="Amount" class="form-label">Total Amount</label>
                            <input asp-for="Amount" class="form-control" type="number" step="0.01"
                                   id="totalAmount" readonly tabindex="-1" style="font-size: 1.2rem; font-weight: bold;" />
                            <span asp-validation-for="Amount" class="text-danger"></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card mb-4 shadow-sm">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0"><i class="bi bi-cart"></i> Product Lines</h5>
            </div>
            <div class="card-body">
                <div class="row mb-3 g-2">
                    <div class="col-md-4">
                        <select id="productDropdown" class="form-select" tabindex="6">
                            <option value="">-- Select Product --</option>
                            @foreach (var item in inventory)
                            {
                                <option value="@item.ProductName" 
                                        data-qty="@item.TotalQuantity" 
                                        data-price="@item.LastSellingPrice">
                                    @item.ProductName (Available: @item.TotalQuantity)
                                </option>
                            }
                        </select>
                    </div>
                    <div class="col-md-2">
                        <input type="number" id="quantity" class="form-control"
                               placeholder="Quantity" min="1" tabindex="7" />
                    </div>
                    <div class="col-md-3">
                        <input type="number" id="unitPrice" class="form-control"
                               placeholder="Unit Price" step="0.01" min="0.01" tabindex="-1" 
                               style="background-color: #e9ecef;" />
                    </div>
                    <div class="col-md-3">
                        <button type="button" class="btn btn-success w-100"
                                onclick="addProductLine()" tabindex="8">
                            <i class="bi bi-plus-circle"></i> Add Product
                        </button>
                    </div>
                </div>

                <div class="table-responsive">
                    <table class="table table-bordered table-hover" id="productTable">
                        <thead class="table-light">
                            <tr>
                                <th width="50">#</th>
                                <th>Description</th>
                                <th width="100">Qty</th>
                                <th width="150">Unit Price</th>
                                <th width="150">Total</th>
                                <th width="100">Action</th>
                            </tr>
                        </thead>
                        <tbody id="productLines">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="hiddenLines"></div>

        <div class="mb-3">
            <button type="submit" class="btn btn-primary btn-lg" tabindex="9">
                <i class="bi bi-save"></i> @(Model.SalesID == 0 ? "Save Invoice" : "Update Invoice")
            </button>
            <a asp-action="Index" class="btn btn-secondary btn-lg">
                <i class="bi bi-x-circle"></i> Cancel
            </a>
        </div>
    </form>
</div>

@section Scripts {
    <script>
        let lineNumber = 1;
        let totalAmount = 0;
        let productLinesArray = [];
        let inventoryData = @Html.Raw(Json.Serialize(inventory));

        document.addEventListener('DOMContentLoaded', function () {
            const inputs = document.querySelectorAll('input:not([readonly]):not([type="hidden"]), select');

            inputs.forEach((input, index) => {
                input.addEventListener('keydown', function (e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();

                        if (input.id === 'quantity') {
                            addProductLine();
                            document.getElementById('productDropdown').focus();
                            return;
                        }

                        const nextInput = inputs[index + 1];
                        if (nextInput) {
                            nextInput.focus();
                        }
                    }
                });
            });

            // Product dropdown change event
            document.getElementById('productDropdown').addEventListener('change', function() {
                const selectedOption = this.options[this.selectedIndex];
                const price = selectedOption.getAttribute('data-price');
                
                if (price && price !== 'null') {
                    document.getElementById('unitPrice').value = parseFloat(price).toFixed(2);
                } else {
                    document.getElementById('unitPrice').value = '';
                }
                
                // Focus on quantity field
                document.getElementById('quantity').focus();
            });
        });

        function addProductLine() {
            const productDropdown = document.getElementById('productDropdown');
            const productName = productDropdown.value.trim();
            const quantity = parseInt(document.getElementById('quantity').value);
            const unitPrice = parseFloat(document.getElementById('unitPrice').value);

            if (!productName) {
                alert('Please select a product.');
                productDropdown.focus();
                return;
            }

            if (!quantity || quantity <= 0) {
                alert('Please enter a valid quantity.');
                document.getElementById('quantity').focus();
                return;
            }

            if (!unitPrice || unitPrice <= 0) {
                alert('Unit price must be greater than zero.');
                return;
            }

            // Get available quantity from dropdown
            const selectedOption = productDropdown.options[productDropdown.selectedIndex];
            const availableQty = parseInt(selectedOption.getAttribute('data-qty'));

            // Check if product already exists in the list
            const existingProductIndex = productLinesArray.findIndex(p => p.productName === productName);
            let totalRequestedQty = quantity;

            if (existingProductIndex !== -1) {
                totalRequestedQty += productLinesArray[existingProductIndex].quantity;
            }

            // Validate against available inventory
            if (totalRequestedQty > availableQty) {
                alert(`Insufficient inventory for ${productName}. Available: ${availableQty}, Requested: ${totalRequestedQty}`);
                return;
            }

            const total = quantity * unitPrice;

            productLinesArray.push({
                salesLineId: 0,
                productName: productName,
                quantity: quantity,
                unitPrice: unitPrice,
                total: total
            });

            totalAmount += total;
            document.getElementById('totalAmount').value = totalAmount.toFixed(2);

            productDropdown.selectedIndex = 0;
            document.getElementById('quantity').value = '';
            document.getElementById('unitPrice').value = '';

            rerenderTable();
            updateHiddenFields();

            productDropdown.focus();
        }

        function deleteLine(index) {
            const lineTotal = productLinesArray[index].total;
            productLinesArray.splice(index, 1);

            totalAmount -= lineTotal;
            document.getElementById('totalAmount').value = totalAmount.toFixed(2);

            rerenderTable();
            updateHiddenFields();
        }

        function rerenderTable() {
            const tbody = document.getElementById('productLines');
            tbody.innerHTML = '';
            lineNumber = 1;

            productLinesArray.forEach((line, index) => {
                const row = `
                    <tr>
                        <td class="text-center">${lineNumber}</td>
                        <td>${line.productName}</td>
                        <td class="text-center">${line.quantity}</td>
                        <td class="text-end">${line.unitPrice.toFixed(2)}</td>
                        <td class="text-end">${line.total.toFixed(2)}</td>
                        <td class="text-center">
                            <button type="button" class="btn btn-danger btn-sm" onclick="deleteLine(${index})">
                                <i class="bi bi-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
                tbody.insertAdjacentHTML('beforeend', row);
                lineNumber++;
            });
        }

        function updateHiddenFields() {
            const hiddenContainer = document.getElementById('hiddenLines');
            hiddenContainer.innerHTML = '';

            productLinesArray.forEach((line, index) => {
                hiddenContainer.innerHTML += `
                    <input type="hidden" name="SalesLines[${index}].SalesLineID" value="${line.salesLineId}" />
                    <input type="hidden" name="SalesLines[${index}].ProductName" value="${line.productName}" />
                    <input type="hidden" name="SalesLines[${index}].Quantity" value="${line.quantity}" />
                    <input type="hidden" name="SalesLines[${index}].UnitPrice" value="${line.unitPrice}" />
                    <input type="hidden" name="SalesLines[${index}].Total" value="${line.total}" />
                `;
            });
        }

        document.getElementById('invoiceForm').addEventListener('submit', function (e) {
            const amount = parseFloat(document.getElementById('totalAmount').value);
            if (amount <= 0 || productLinesArray.length === 0) {
                e.preventDefault();
                alert('Amount cannot be zero. Please add at least one product.');
            }
        });
    </script>

    @if (Model.SalesLines != null && Model.SalesLines.Any())
    {
        <script>
            document.addEventListener("DOMContentLoaded", function () {
            @foreach (var line in Model.SalesLines)
            {
                <text>
                            productLinesArray.push({
                                salesLineId: @line.SalesLineID,
                                productName: "@line.ProductName",
                                quantity: @line.Quantity,
                                unitPrice: @line.UnitPrice,
                                total: @line.Total
                            });
                            totalAmount += @line.Total;
                </text>
            }

                document.getElementById('totalAmount').value = totalAmount.toFixed(2);
                rerenderTable();
                updateHiddenFields();
            });
        </script>
    }
}